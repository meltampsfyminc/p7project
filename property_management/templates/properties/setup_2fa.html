{% extends 'properties/base.html' %}

{% block title %}Setup 2FA - Property Management System{% endblock %}

{% block extra_css %}
<style>
    .setup-container {
        max-width: 600px;
        margin: 2rem auto;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .setup-container h2 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5rem;
    }

    .setup-step {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #ecf0f1;
        border-radius: 4px;
    }

    .setup-step h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }

    .setup-step ol, .setup-step ul {
        color: #555;
        margin-left: 1.5rem;
    }

    .setup-step li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }

    .qr-code {
        text-align: center;
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: white;
        border-radius: 4px;
        border: 2px solid #3498db;
    }

    .qr-code img {
        max-width: 250px;
        height: auto;
    }

    .secret-key {
        background: white;
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
        font-family: monospace;
        word-break: break-all;
        color: #e74c3c;
        font-weight: bold;
    }

    .verification-form {
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: white;
        border-radius: 4px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-group input:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .button-group button, .button-group a {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .btn-primary-form {
        background-color: #3498db;
        color: white;
    }

    .btn-primary-form:hover {
        background-color: #2980b9;
    }

    .btn-danger-form {
        background-color: #e74c3c;
        color: white;
    }

    .btn-danger-form:hover {
        background-color: #c0392b;
    }

    .btn-secondary-form {
        background-color: #95a5a6;
        color: white;
    }

    .btn-secondary-form:hover {
        background-color: #7f8c8d;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .status-enabled {
        background-color: #d4edda;
        color: #155724;
    }

    .status-disabled {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="setup-container">
    <h2>Two-Factor Authentication (2FA) Setup</h2>
    
    <div style="margin-bottom: 1.5rem;">
        <p style="font-size: 0.95rem; color: #555;">Status: <span class="status-badge {% if profile.is_2fa_enabled %}status-enabled{% else %}status-disabled{% endif %}">{% if profile.is_2fa_enabled %}Enabled{% else %}Not Enabled{% endif %}</span></p>
    </div>

    {% if profile.is_2fa_enabled %}
        <!-- 2FA is Enabled -->
        <div class="alert alert-info">
            <strong>2FA is currently enabled.</strong> You're protected with Two-Factor Authentication.
        </div>

        <div class="setup-step">
            <h3>Your 2FA is Active</h3>
            <p>Your account is protected with Time-based One-Time Password (TOTP) authentication. You'll need to provide a code from your authenticator app when logging in.</p>
            
            <div class="button-group">
                <a href="{% url 'properties:view_backup_codes' %}" class="btn-secondary-form">View Backup Codes</a>
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="disable">
                    <button type="submit" class="btn-danger-form" onclick="return confirm('Are you sure? This will disable 2FA for your account.');">Disable 2FA</button>
                </form>
            </div>
        </div>

    {% else %}
        <!-- 2FA is Disabled - Show Setup Instructions -->
        <div class="alert alert-warning">
            <strong>2FA is not enabled.</strong> Enable it to add an extra layer of security to your account.
        </div>

        <div class="setup-step">
            <h3>Step 1: Download an Authenticator App</h3>
            <p>Install one of these authenticator apps on your phone:</p>
            <ul>
                <li>Google Authenticator</li>
                <li>Microsoft Authenticator</li>
                <li>Authy</li>
                <li>1Password</li>
                <li>Any TOTP-compatible authenticator</li>
            </ul>
        </div>

        <div class="setup-step">
            <h3>Step 2: Generate Your Secret</h3>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="generate">
                <p style="margin-bottom: 1rem;">Click the button below to generate your unique 2FA secret code.</p>
                <button type="submit" class="btn-primary-form">Generate Secret Code</button>
            </form>
        </div>

        {% if profile.totp_secret %}
            <div class="setup-step">
                <h3>Step 3: Scan QR Code</h3>
                <p style="margin-bottom: 1rem;">Use your authenticator app to scan this QR code:</p>
                
                <div class="qr-code">
                    {% if qr_code_image %}
                        <img src="data:image/png;base64,{{ qr_code_image }}" alt="QR Code for 2FA Setup">
                    {% endif %}
                </div>

                <p style="margin-bottom: 1rem; color: #555;"><strong>Can't scan?</strong> Enter this key manually:</p>
                <div class="secret-key">{{ profile.totp_secret }}</div>
            </div>

            <div class="setup-step">
                <h3>Step 4: Verify Your Authenticator</h3>
                <p style="margin-bottom: 1rem;">Enter the 6-digit code from your authenticator app to complete setup:</p>
                
                <form method="post" class="verification-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify">
                    
                    <div class="form-group">
                        <label for="totp_code">Verification Code (6 digits)</label>
                        <input 
                            type="text" 
                            id="totp_code" 
                            name="totp_code" 
                            placeholder="000000" 
                            maxlength="6" 
                            pattern="[0-9]{6}"
                            required
                            autofocus
                        >
                        <small style="color: #7f8c8d;">Enter the 6-digit code from your authenticator app</small>
                    </div>

                    <button type="submit" class="btn-primary-form">Enable 2FA</button>
                </form>
            </div>
        {% endif %}
    {% endif %}

    <!-- Information Box -->
    <div class="setup-step" style="background: #e8f4f8; border-left: 4px solid #3498db;">
        <h3 style="margin-top: 0;">About 2FA</h3>
        <ul>
            <li><strong>More Secure:</strong> Even if someone has your password, they can't access your account without the 2FA code.</li>
            <li><strong>Recovery Codes:</strong> Save your backup codes in a safe place. You can use them to access your account if you lose your phone.</li>
            <li><strong>Time-Based:</strong> Codes change every 30 seconds for added security.</li>
            <li><strong>Compatible:</strong> Works with any TOTP-based authenticator app.</li>
        </ul>
    </div>

    <div style="text-align: center; margin-top: 2rem;">
        <a href="{% url 'properties:dashboard' %}" class="btn btn-secondary-form">Back to Dashboard</a>
    </div>
</div>
{% endblock %}
